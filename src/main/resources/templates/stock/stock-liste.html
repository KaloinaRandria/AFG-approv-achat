<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <title>État de Stock</title>
    <th:block th:insert="~{fragment/load_css :: load_css}"></th:block>
    <th:block th:insert="~{fragment/font :: font}"></th:block>
    <th:block th:insert="~{fragment/load_script :: load_script}"></th:block>
</head>

<body>
<div th:replace="~{fragment/sidebar :: sidebar}"></div>
<div class="main-content">
    <section>

        <!-- En-tête -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold text-gradient-blue">
                <i class="fas fa-warehouse me-3 icon-gradient-blue"></i> État de Stock
            </h1>

            <div>
                <!-- Bouton pour voir les notifications dans un modal -->
                <button type="button" class="btn btn-gradient-orange me-2 position-relative notification-btn-main"
                        data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    <i class="fas fa-bell me-2"></i> Notifications
                    <span th:if="${alertesCount != null && alertesCount > 0}"
                          class="notification-badge-main badge rounded-pill bg-danger border border-2 border-white">
        <span th:text="${alertesCount > 99 ? '99+' : alertesCount}"></span>
        <span class="visually-hidden">alertes non lues</span>
    </span>
                </button>

                <a th:href="@{/admin/article/list}" class="btn btn-gradient-blue">
                    <i class="fas fa-box me-3"></i> Liste des Articles
                </a>
            </div>
        </div>

        <!-- Carte contenant le tableau -->
        <div class="card shadow-lg border-0">
            <div class="card-body">

                <div class="table-responsive">
                    <table id="etatStockTable" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th><i class="fas fa-box me-2 icon-gradient-light-blue"></i>Article</th>
                            <th><i class="fas fa-exclamation-triangle me-2 icon-gradient-light-blue"></i>Seuil minimum
                            </th>
                            <th><i class="fas fa-sign-in-alt me-2 icon-gradient-light-blue"></i>Entrée</th>
                            <th><i class="fas fa-sign-out-alt me-2 icon-gradient-light-blue"></i>Sortie</th>
                            <th><i class="fas fa-chart-pie me-2 icon-gradient-light-blue"></i>Stock Disponible</th>
                            <th><i class="fas fa-balance-scale me-2 icon-gradient-light-blue"></i>UDM</th>
                            <th><i class="fas fa-bell me-2 icon-gradient-light-blue"></i>Notification</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="e : ${etatStocks}">
                            <td>
                                <strong th:text="${e.codeArticle}"></strong><br>
                                <small class="text-muted" th:text="${e.designation}"></small>
                            </td>
                            <td class="text-end fw-bold text-seuil"
                                th:text="${T(afg.achat.afgApprovAchat.service.util.FormatNumber).format(e.seuilMin)}">
                            </td>

                            <td class="text-end fw-bold text-entree"
                                th:text="${T(afg.achat.afgApprovAchat.service.util.FormatNumber).format(e.totalEntree)}">
                            </td>

                            <td class="text-end fw-bold text-sortie"
                                th:text="${T(afg.achat.afgApprovAchat.service.util.FormatNumber).format(e.totalSortie)}">
                            </td>

                            <td class="text-end fw-bold text-stock"
                                th:text="${T(afg.achat.afgApprovAchat.service.util.FormatNumber).format(e.stockDisponible)}">
                            </td>
                            <td class="text-end fw-bold text-stock"
                                th:text="${e.udm}">
                            </td>

                            <td class="text-center">
                                <!-- Vérifier si l'article a une alerte -->
                                <th:block th:if="${e.alerte != null}">
                                    <!-- Rupture de stock -->
                                    <th:block th:if="${e.alerte.typeAlerte == 'RUPTURE'}">
                                        <span class="notification-badge badge bg-danger text-light p-2 notification-pulse"
                                              title="Rupture de stock - Cliquez pour voir les détails"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              th:data-code="${e.codeArticle}"
                                              th:data-designation="${e.designation}"
                                              th:data-stock="${e.stockDisponible}"
                                              th:data-seuil="${e.seuilMin}"
                                              th:data-type="RUPTURE"
                                              th:data-udm="${e.udm}"
                                              onclick="showAlertFromRow(this)">
                                            <i class="fas fa-exclamation-circle me-1"></i> Rupture
                                        </span>
                                    </th:block>

                                    <!-- Seuil minimum atteint -->
                                    <th:block th:if="${e.alerte.typeAlerte == 'SEUIL'}">
                                        <span class="notification-badge badge bg-warning text-dark p-2"
                                              title="Seuil minimum atteint - Cliquez pour voir les détails"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              th:data-code="${e.codeArticle}"
                                              th:data-designation="${e.designation}"
                                              th:data-stock="${e.stockDisponible}"
                                              th:data-seuil="${e.seuilMin}"
                                              th:data-type="SEUIL"
                                              th:data-udm="${e.udm}"
                                              onclick="showAlertFromRow(this)">
                                            <i class="fas fa-exclamation-triangle me-1"></i> Seuil
                                        </span>
                                    </th:block>
                                </th:block>

                                <!-- Pas d'alerte -->
                                <th:block th:unless="${e.alerte != null}">
                                    <span class="badge bg-success text-light p-2"
                                          title="Stock normal"
                                          data-bs-toggle="tooltip"
                                          data-bs-placement="top">
                                        <i class="fas fa-check-circle me-1"></i> OK
                                    </span>
                                </th:block>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>

            </div>
        </div>

    </section>
</div>

<!-- Modal pour afficher les détails de l'alerte -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">Détails de l'Alerte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert" id="alertModalType">
                    <h4 id="alertModalArticle"></h4>
                    <p><strong>État du stock :</strong> <span id="alertModalStock"></span></p>
                    <p><strong>Seuil minimum :</strong> <span id="alertModalSeuil"></span></p>
                    <p><strong>Udm :</strong> <span id="alertModalUdm"></span></p>
                    <p id="alertModalMessage"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <!--                <button type="button" class="btn btn-primary" onclick="goToArticle()">-->
                <!--                    <i class="fas fa-edit me-1"></i> Modifier l'article-->
                <!--                </button>-->
            </div>
        </div>
    </div>
</div>


<!-- Modal des notifications -->
<div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-blue text-white">
                <h5 class="modal-title" id="notificationsModalLabel">
                    <i class="fas fa-bell me-2"></i> Alertes de Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">

                <!-- En-tête avec compteur -->
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <h6 class="mb-0">
                        <span th:if="${alertesCount != null && alertesCount > 0}">
                            <span th:text="${alertesCount}"></span> alerte<span th:if="${alertesCount > 1}">s</span> active<span
                                th:if="${alertesCount > 1}">s</span>
                        </span>
                        <span th:unless="${alertesCount != null && alertesCount > 0}">
                            Aucune alerte active
                        </span>
                    </h6>
                    <div>
                        <span class="badge bg-danger me-2">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            Rupture: <span th:text="${ruptureCount != null ? ruptureCount : 0}"></span>
                        </span>
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Seuil: <span th:text="${seuilCount != null ? seuilCount : 0}"></span>
                        </span>
                    </div>
                </div>

                <!-- Liste des alertes -->
                <div class="notifications-container" style="max-height: 60vh; overflow-y: auto;">

                    <!-- Si aucune alerte -->
                    <div th:if="${#lists.isEmpty(alertes)}"
                         class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-success mb-3 opacity-50"></i>
                        <h5 class="text-muted">Aucune alerte active</h5>
                        <p class="text-muted small">Tous les stocks sont dans les normes</p>
                    </div>

                    <!-- Boucle sur les alertes -->
                    <div th:each="a : ${alertes}"
                         th:unless="${#lists.isEmpty(alertes)}"
                         class="notification-item border-bottom p-3"
                         th:classappend="${a.getTypeAlerte() == 'RUPTURE'} ? 'alert-rupture' : 'alert-seuil'"
                         style="cursor: pointer;"
                         th:data-code="${a.getCodeArticle()}"
                         th:data-designation="${a.getDesignation()}"
                         th:data-type="${a.getTypeAlerte()}"
                         th:data-stock="${a.getStockDisponible()}"
                         th:data-seuil="${a.getSeuilMin()}"
                         th:data-udm="${a.getUdm()}"
                         onclick="handleNotificationClick(this)">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1 fw-bold">
                                    <i class="fas fa-box me-2 text-primary"></i>
                                    <span th:text="${a.getCodeArticle()}"></span>
                                </h6>
                                <p class="text-muted small mb-2" th:text="${a.getDesignation()}"></p>
                            </div>
                            <div>
                                <span th:if="${a.getTypeAlerte() == 'RUPTURE'}"
                                      class="badge bg-danger text-light px-3 py-2">
                                    <i class="fas fa-exclamation-circle me-1"></i> Rupture
                                </span>
                                <span th:if="${a.getTypeAlerte() == 'SEUIL'}"
                                      class="badge bg-warning text-dark px-3 py-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i> Seuil
                                </span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <i class="fas fa-chart-pie me-2 text-info"></i>
                                    <strong>Stock disponible :</strong>
                                    <span class="fw-bold"
                                          th:classappend="${a.getTypeAlerte() == 'RUPTURE'} ? 'text-danger' : 'text-warning'"
                                          th:text="${a.getStockDisponible()}"></span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                    <strong>Seuil minimum :</strong>
                                    <span class="fw-bold text-seuil" th:text="${a.getSeuilMin()}"></span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span th:if="${a.getTypeAlerte() == 'RUPTURE'}">
                                    Stock épuisé - Réapprovisionnement urgent nécessaire
                                </span>
                                <span th:if="${a.getTypeAlerte() == 'SEUIL'}">
                                    Stock inférieur au seuil - Pensez à commander
                                </span>
                            </small>
                        </div>

                    </div>

                </div>
            </div>
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">-->
<!--                    <i class="fas fa-times me-1"></i> Fermer-->
<!--                </button>-->
<!--                <button type="button" class="btn btn-gradient-blue" onclick="exportNotifications()">-->
<!--                    <i class="fas fa-download me-1"></i> Exporter-->
<!--                </button>-->
<!--                <button type="button" class="btn btn-gradient-green" onclick="markAllAsRead()"-->
<!--                        th:if="${alertesCount != null && alertesCount > 0}">-->
<!--                    <i class="fas fa-check-double me-1"></i> Tout marquer comme lu-->
<!--                </button>-->
<!--            </div>-->
        </div>
    </div>
</div>

<script th:inline="none">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // Initialiser les tooltips Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const table = $('#etatStockTable').DataTable({
            language: {
                zeroRecords: "Aucun résultat trouvé",
                search: "Rechercher:",
                lengthMenu: "Afficher _MENU_",
                info: "Affichage de _START_ à _END_ sur _TOTAL_ lignes",
                infoEmpty: "Aucune donnée disponible",
                paginate: {
                    first: "Première",
                    last: "Dernière",
                    next: "Suivante",
                    previous: "Précédente"
                }
            },
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
            responsive: true,
            dom: '<"row"<"col-md-6"l><"col-md-6">><"row"<"col-12"tr>><"row"<"col-md-5"i><"col-md-7"p>>',
            columnDefs: [
                {
                    targets: [6], // Colonne notification (index 5)
                    orderable: false, // Désactiver le tri sur cette colonne
                    searchable: false // Désactiver la recherche sur cette colonne
                }
            ],

            initComplete: function () {
                const api = this.api();

                // Clonage de la ligne d'entête pour les filtres
                $('#etatStockTable thead tr').clone(true).appendTo('#etatStockTable thead');

                $('#etatStockTable thead tr:eq(1) th').each(function (i) {
                    if (i < 6) { // Exclure la colonne notification du filtre
                        $(this).html('<input class="form-control form-control-sm" type="text" placeholder="Filtrer..." />');
                        $('input', this).on('keyup change', function () {
                            if (api.column(i).search() !== this.value) {
                                api.column(i).search(this.value).draw();
                            }
                        });
                    } else {
                        $(this).html('<span class="text-muted">-</span>');
                    }
                });

                // ✅ Recherche mobile
                $('<div class="mobile-search-container mb-3">' +
                    '<div class="input-group">' +
                    '<span class="input-group-text"><i class="fas fa-search"></i></span>' +
                    '<input type="text" class="form-control" id="mobileSearchStock" placeholder="Rechercher dans le stock...">' +
                    '</div>' +
                    '</div>').insertBefore('#etatStockTable');

                $('#mobileSearchStock').on('keyup', function () {
                    api.search(this.value).draw();
                });

                function toggleMobileSearch() {
                    if ($(window).width() <= 768) {
                        $('.mobile-search-container').show();
                        $('#etatStockTable thead tr:eq(1)').hide();
                        $('.dataTables_filter').hide();
                    } else {
                        $('.mobile-search-container').hide();
                        $('#etatStockTable thead tr:eq(1)').show();
                        $('.dataTables_filter').show();
                    }
                }

                toggleMobileSearch();
                $(window).on('resize', toggleMobileSearch);
            }
        });
    });

    // Fonction pour afficher les détails de l'alerte à partir de l'élément
    function showAlertDetailsFromElement(element) {
        const codeArticle = element.getAttribute('data-code-article');
        const designation = element.getAttribute('data-designation');
        const stock = element.getAttribute('data-stock');
        const seuil = element.getAttribute('data-seuil');
        const type = element.getAttribute('data-alerte-type');
        const udm = element.getAttribute('data-udm');

        showAlertDetails(codeArticle, designation, type, stock, seuil, udm);
    }

    // Fonction existante modifiée (facultatif - pour gérer aussi l'appel direct)
    function showAlertDetails(codeArticle, designation, type, stock, seuil, udm) {
        const modal = new bootstrap.Modal(document.getElementById('alertModal'));
        const alertDiv = document.getElementById('alertModalType');
        const articleSpan = document.getElementById('alertModalArticle');
        const stockSpan = document.getElementById('alertModalStock');
        const seuilSpan = document.getElementById('alertModalSeuil');
        const messageSpan = document.getElementById('alertModalMessage');
        const udmSpan = document.getElementById('alertModalUdm');

        // Décoder les valeurs si nécessaire (pour les apostrophes, etc.)
        const decodedDesignation = decodeHtmlEntities(designation);

        // Mettre à jour le contenu
        articleSpan.textContent = codeArticle + ' - ' + decodedDesignation;
        stockSpan.textContent = stock;
        seuilSpan.textContent = seuil;
        udmSpan.textContent = udm;

        // Configurer selon le type d'alerte
        if (type === 'RUPTURE') {
            alertDiv.className = 'alert alert-danger';
            messageSpan.textContent = 'Le stock est épuisé. Une commande urgente est nécessaire.';
            document.getElementById('alertModalLabel').textContent = 'Rupture de Stock';
        } else if (type === 'SEUIL') {
            alertDiv.className = 'alert alert-warning';
            messageSpan.textContent = 'Le stock est inférieur au seuil minimum. Pensez à réapprovisionner.';
            document.getElementById('alertModalLabel').textContent = 'Seuil Minimum Atteint';
        }

        // Stocker le code article pour le bouton "Modifier"
        alertDiv.dataset.articleCode = codeArticle;

        modal.show();
    }

    // Fonction utilitaire pour décoder les entités HTML
    function decodeHtmlEntities(text) {
        const textArea = document.createElement('textarea');
        textArea.innerHTML = text;
        return textArea.value;
    }

    function showAlertFromRow(element) {
        const codeArticle = element.getAttribute('data-code');
        const designation = element.getAttribute('data-designation');
        const stock = element.getAttribute('data-stock');
        const seuil = element.getAttribute('data-seuil');
        const type = element.getAttribute('data-type');
        const udm = element.getAttribute('data-udm');

        showAlertDetails(codeArticle, designation, type, stock, seuil, udm);
    }


    /* ===== FONCTIONS POUR LE MODAL DE NOTIFICATIONS ===== */

    // Fonction pour gérer le clic sur une notification
    function handleNotificationClick(element) {
        const codeArticle = element.getAttribute('data-code');
        const designation = element.getAttribute('data-designation');
        const type = element.getAttribute('data-type');
        const stock = element.getAttribute('data-stock');
        const seuil = element.getAttribute('data-seuil');
        const udm = element.getAttribute('data-udm');
        showAlertDetailsFromNotification(codeArticle, designation, type, stock, seuil, udm);
    }

    // Fonction pour afficher les détails d'une alerte depuis le modal
    function showAlertDetailsFromNotification(codeArticle, designation, type, stock, seuil, udm) {
        // Fermer le modal des notifications
        const notificationModal = bootstrap.Modal.getInstance(document.getElementById('notificationsModal'));
        if (notificationModal) {
            notificationModal.hide();
        }

        // Afficher le modal de détails de l'alerte
        showAlertDetails(codeArticle, designation, type, stock, seuil, udm);
    }

    /*]]>*/
</script>
</body>
</html>