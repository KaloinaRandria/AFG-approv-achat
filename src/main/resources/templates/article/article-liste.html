<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


<head>
    <title>Liste des Articles</title>
    <th:block th:insert="~{fragment/load_css :: load_css}"></th:block>
    <th:block th:insert="~{fragment/font :: font}"></th:block>
    <th:block th:insert="~{fragment/load_script :: load_script}"></th:block>
</head>

<body>
<div th:replace="~{fragment/sidebar :: sidebar}"></div>

<div class="main-content">
    <section>
        <!-- En-tête avec icônes en dégradé bleu -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold text-gradient-blue">
                <i class="fas fa-box me-3 icon-gradient-blue"></i> Liste des Articles
            </h1>
            <div>
                <!-- Dans votre HTML -->
                <a th:href="@{/admin/stock/etat-stock}" class="btn btn-gradient-blue me-2">
                    <i class="fas fa-warehouse me-3"></i>État de stock
                </a>

                <a th:href="@{/article/add}" sec:authorize="hasAnyRole('ADMIN','MOYENS_GENERAUX')" class="btn btn-gradient-green">
                    <i class="fas fa-plus-circle me-1"></i>Nouvel article
                </a>
            </div>
        </div>

        <div th:replace="~{fragment/load_pop_up :: pop_up}"></div>

        <!-- Carte contenant le tableau -->
        <div class="card shadow-lg border-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="articlesTable" class="table table-striped table-hover">
                        <thead>
                        <tr>
                            <th><i class="fas fa-hashtag me-2 icon-gradient-light-blue"></i>Code</th>
                            <th><i class="fas fa-tag me-2 icon-gradient-light-blue"></i>Désignation</th>
                            <th><i class="fas fa-layer-group me-2 icon-gradient-light-blue"></i>Famille</th>
                            <th><i class="fas fa-chart-line me-2 icon-gradient-light-blue"></i>Seuil Minimum</th>
                            <th><i class="fas fa-balance-scale me-2 icon-gradient-light-blue"></i>UDM</th>
                            <th><i class="fas fa-cogs me-2 icon-gradient-light-blue"></i>Actions</th>
                            <th><i class="fas fa-exchange-alt me-2 icon-gradient-light-blue"></i>Simulation Stock</th>
                        </tr>
                        </thead>

                        <tbody>
                        <tr th:each="a : ${articles}">
                            <td th:text="${a.getCodeArticle()}"></td>
                            <td th:text="${a.getDesignation()}"></td>
                            <td th:text="${a.famille != null ? a.famille.getDescription() : '---'}"></td>
                            <td class="text-end"
                                th:text="${T(afg.achat.afgApprovAchat.service.util.FormatNumber).format(a.seuilMin)}"></td>
                            <td th:text="${a.udm != null ? a.udm.getDescription() : '---'}"></td>
                            <td>
                                <button type="button"
                                        class="btn btn-sm edit-btn"
                                        sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MOYENS_GENERAUX')"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modifierModal"
                                        th:data-codearticle="${a.getCodeArticle()}"
                                        th:data-designation="${a.getDesignation()}"
                                        th:data-seuilminimum="${a.getSeuilMin()}"
                                        th:data-idudm="${a.udm != null ? a.udm.getId() : ''}"
                                        th:data-idfamille="${a.famille != null ? a.famille.getId() : ''}"
                                        th:data-idcentre="${a.centreBudgetaire != null ? a.centreBudgetaire.getId() : ''}"
                                        title="Modifier l'article">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <!-- Bouton Historique (modal) -->
                                <button type="button"
                                        class="btn btn-sm historique-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#historiqueModal"
                                        th:data-codearticle="${a.getCodeArticle()}"
                                        th:data-designation="${a.getDesignation()}"
                                        title="Voir l'historique">
                                    <i class="fas fa-history"></i>
                                </button>
                            </td>
                            <td>
                                <a th:href="@{/admin/article/entree-saisie/{codeArticle}(codeArticle=${a.getCodeArticle()})}"
                                   class="btn btn-success btn-sm" title="Entrée en stock">
                                    <i class="fas fa-plus-circle"></i>
                                </a>
                                <a th:href="@{/admin/article/sortie-saisie/{codeArticle}(codeArticle=${a.getCodeArticle()})}"
                                   class="btn btn-danger btn-sm" title="Sortie de stock">
                                    <i class="fas fa-minus-circle"></i>
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Modal pour la modification d'article -->
<div class="modal fade" id="modifierModal" tabindex="-1" aria-labelledby="modifierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header btn-gradient-blue">
                <h5 class="modal-title" id="modifierModalLabel">
                    <i class="fas fa-edit me-2 icon-gradient-blue"></i>Modifier l'article
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <form th:action="@{/admin/article/modifier}" method="post" id="articleForm">
                <div class="modal-body">
                    <input type="hidden" id="modalCodeArticle" name="codeArticle">
                    <div class="mb-3">
                        <label for="modalDesignation" class="form-label">
                            <i class="fas fa-tag me-2 icon-gradient-blue"></i>Désignation *
                        </label>
                        <input type="text" class="form-control" id="modalDesignation" name="designation" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalSeuil" class="form-label">
                            <i class="fas fa-chart-line me-2 icon-gradient-blue"></i>SeuilMinimum *
                        </label>
                        <input type="text" class="form-control" id="modalSeuil" name="seuilMinimum" required>
                    </div>
                    <div class="mb-3">
                        <label for="modalUdm" class="form-label">
                            <i class="fas fa-balance-scale me-2 icon-gradient-blue"></i>Unité de mesure
                        </label>
                        <select class="form-control" id="modalUdm" name="idUdm">
                            <option value="">Sélectionner une unité</option>
                            <option th:each="udm : ${udms}" th:value="${udm.getId()}"
                                    th:text="${udm.getDescription() + ' - ' + udm.getAcronyme()}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modalFamille" class="form-label">
                            <i class="fas fa-layer-group me-2 icon-gradient-blue"></i>Famille
                        </label>
                        <select class="form-control" id="modalFamille" name="idFamille">
                            <option value="">Sélectionner une famille</option>
                            <option th:each="famille : ${familles}" th:value="${famille.getId()}"
                                    th:text="${famille.getDescription()}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modalCentre" class="form-label">
                            <i class="fas fa-building me-2 icon-gradient-blue"></i>Centre Budgetaire
                        </label>
                        <select class="form-control" id="modalCentre" name="idCentreBudgetaire">
                            <option value="">Sélectionner un centre</option>
                            <option th:each="centre : ${centres}" th:value="${centre.getId()}"
                                    th:text="${centre.getCodeCentre()}"></option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-gradient-blue">
                        <i class="fas fa-save me-1"></i>Modifier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour l'historique des modifications -->
<div class="modal fade" id="historiqueModal" tabindex="-1" aria-labelledby="historiqueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historiqueModalLabel">
                    <i class="fas fa-history me-2 icon-gradient-blue"></i>Historique des modifications
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 id="historiqueArticleInfo" class="mb-0"></h6>
                    <span class="badge bg-gradient-blue" id="historiqueCount">0 modification(s)</span>
                </div>

                <!-- Tableau pour l'historique - Style carte -->
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th class="border-0 py-3 ps-4"><i class="far fa-clock me-2 text-muted"></i>Date & Heure
                                </th>
                                <th class="border-0 py-3"><i class="far fa-user me-2 text-muted"></i>Utilisateur</th>
                                <th class="border-0 py-3"><i class="far fa-edit me-2 text-muted"></i>Modification</th>
                                <th class="border-0 py-3"><span class="badge bg-light text-danger"><i
                                        class="fas fa-arrow-left me-1"></i> Ancien</span></th>
                                <th class="border-0 py-3 pe-4"><span class="badge bg-light text-success"><i
                                        class="fas fa-arrow-right me-1"></i> Nouveau</span></th>
                            </tr>
                            </thead>
                            <tbody id="historiqueTableBody">
                            <!-- Les données seront chargées dynamiquement ici -->
                            <tr id="historiqueEmptyRow">
                                <td colspan="5" class="text-center py-5">
                                    <div class="empty-state-content">
                                        <div class="empty-state-icon bg-light rounded-circle p-4 mb-3">
                                            <i class="fas fa-inbox fa-lg text-muted"></i>
                                        </div>
                                        <h5 class="text-muted">Aucun historique</h5>
                                        <p class="text-muted mb-0">Les modifications apparaîtront dans ce journal</p>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination pour l'historique -->
                <nav aria-label="Historique pagination" id="historiquePagination" class="d-none">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Précédent</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Suivant</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>
<script th:inline="none">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const table = $('#articlesTable').DataTable({
            language: {
                zeroRecords: "Aucun article correspondant trouvé",
                search: "Rechercher:",
                lengthMenu: "Afficher _MENU_",
                info: "Affichage de _START_ à _END_ sur _TOTAL_ articles",
                infoEmpty: "Aucun article à afficher",
                infoFiltered: "(filtrés sur _MAX_ articles au total)",
                paginate: {first: "Première", last: "Dernière", next: "Suivante", previous: "Précédente"}
            },
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
            responsive: true,
            dom: '<"row"<"col-md-6"l><"col-md-6">><"row"<"col-12"tr>><"row"<"col-md-5"i><"col-md-7"p>>',
            initComplete: function () {
                const api = this.api();
                // Cloner header pour filtres
                $('#articlesTable thead tr').clone(true).appendTo('#articlesTable thead');
                $('#articlesTable thead tr:eq(1) th').each(function (i) {
                    if (i < 5) { // filtres sur Code, Désignation, Famille, Seuil, UDM
                        $(this).html('<input class="form-control form-control-sm" type="text" placeholder="Filtrer..." />');
                        $('input', this).on('keyup change', function () {
                            if (api.column(i).search() !== this.value) {
                                api.column(i).search(this.value).draw();
                            }
                        });
                    } else {
                        $(this).html('<div style="height:32px;"></div>');
                    }
                });

                // Recherche mobile
                $('<div class="mobile-search-container mb-3">' +
                    '<div class="input-group">' +
                    '<span class="input-group-text"><i class="fas fa-search icon-gradient-blue"></i></span>' +
                    '<input type="text" class="form-control" id="mobileGlobalSearch" placeholder="Rechercher...">' +
                    '</div></div>').insertBefore('#articlesTable');

                $('#mobileGlobalSearch').on('keyup', function () {
                    api.search(this.value).draw();
                });

                function toggleMobileSearch() {
                    if ($(window).width() <= 768) {
                        $('.mobile-search-container').show();
                        $('#articlesTable thead tr:eq(1)').hide();
                        $('.dataTables_filter').hide();
                    } else {
                        $('.mobile-search-container').hide();
                        $('#articlesTable thead tr:eq(1)').show();
                        $('.dataTables_filter').show();
                    }
                }

                toggleMobileSearch();
                $(window).on('resize', toggleMobileSearch);
            }
        });

        // Modal pour modifier
        $('#modifierModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            $('#modalCodeArticle').val(button.data('codearticle'));
            $('#modalDesignation').val(button.data('designation'));
            $('#modalUdm').val(button.data('idudm') || '');
            $('#modalFamille').val(button.data('idfamille') || '');
            $('#modalCentre').val(button.data('idcentre') || '');
            $('#modifierModalLabel').text('Modifier l\'article: ' + button.data('codearticle'));
            $('#modalSeuil').val(button.data('seuilminimum') || '');
        });
        $('#modifierModal').on('hidden.bs.modal', function () {
            $('#articleForm')[0].reset();
        });
    });


    $('#historiqueModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var codeArticle = button.data('codearticle');
        var designation = button.data('designation');

        console.log("Ouverture modal historique pour:", codeArticle, designation);

        // Mettre à jour le titre
        $('#historiqueArticleInfo').text(designation + ' (' + codeArticle + ')');

        // Afficher le loader
        $('#historiqueTableBody').html(`
        <tr>
            <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2 text-muted">Chargement de l'historique...</p>
            </td>
        </tr>
    `);

        // URL du contrôleur - NOTEZ LE CHANGEMENT ICI !
        // Le contrôleur utilise @GetMapping("/article/{codeArticle}")
        // Donc l'URL doit être: /admin/api/historique/article/CODE_ARTICLE
        const url = `/admin/api/historique/article/${encodeURIComponent(codeArticle)}?page=0&size=10`;
        console.log("URL de requête:", url);

        $.ajax({
            url: url,
            method: 'GET',
            success: function (response) {
                console.log("Réponse reçue:", response);

                // Votre contrôleur retourne les données dans response.data
                // et pas directement dans response.historiques
                if (response.data && response.data.length > 0) {
                    let html = '';
                    response.data.forEach(function (historique) {
                        console.log("Historique:", historique);

                        // Déterminer le type de modification basé sur le champ
                        const typeModification = getTypeFromChamp(historique.champ);
                        const description = getDescriptionFromChamp(historique.champ);

                        html += `
                    <tr>
                        <td>${historique.date || '-'}</td>
                        <td>${historique.modifiePar || 'Système'}</td>
                        <td>${description || historique.champ || 'Modification'}</td>
                        <td>${historique.ancienneValeur || '-'}</td>
                        <td>${historique.nouvelleValeur || '-'}</td>
                    </tr>`;
                    });

                    $('#historiqueTableBody').html(html);

                    // Utiliser response.pagination.totalElements si disponible
                    const totalElements = response.pagination ? response.pagination.totalElements : response.data.length;
                    $('#historiqueCount').text(totalElements + ' modification(s)');

                } else {
                    console.log("Aucun historique trouvé");
                    $('#historiqueTableBody').html(`
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-history fa-2x text-muted mb-2"></i>
                            <p class="text-muted">Aucune modification trouvée</p>
                        </td>
                    </tr>
                `);
                    $('#historiqueCount').text('0 modification(s)');
                }
            },
            error: function (xhr, status, error) {
                console.error("Erreur AJAX:", status, error, xhr.responseText);
                $('#historiqueTableBody').html(`
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Erreur lors du chargement de l'historique</p>
                        <small class="text-muted">Status: ${status}, Erreur: ${error}</small>
                        <br><small>Réponse: ${xhr.responseText}</small>
                    </td>
                </tr>
            `);
            }
        });
    });

    // Fonction pour déterminer le type de modification
    function getTypeFromChamp(champ) {
        if (!champ) return "MODIFICATION";

        const champLower = champ.toLowerCase();
        if (champLower === "article") return "CREATION";
        if (champLower.includes("stock")) return "MOUVEMENT_STOCK";
        if (champLower.includes("quantite")) return "STOCK";
        return "MODIFICATION";
    }

    // Fonction pour créer une description lisible
    function getDescriptionFromChamp(champ) {
        if (!champ) return "Modification";

        const descriptions = {
            "designation": "Désignation",
            "seuilmin": "Seuil minimum",
            "famille": "Famille",
            "udm": "Unité de mesure",
            "centrebudgetaire": "Centre budgétaire",
            "article": "Création d'article",
            "stock": "Mouvement de stock",
            "quantite": "Quantité en stock"
        };

        const champLower = champ.toLowerCase();
        return descriptions[champLower] ||
            champ.charAt(0).toUpperCase() + champ.slice(1).toLowerCase();
    }

    // Fonction pour déterminer la classe du badge
    function getBadgeClass(type) {
        if (!type) return 'bg-secondary';

        const typeLower = type.toLowerCase();
        if (typeLower.includes('creation')) return 'bg-success';
        if (typeLower.includes('mouvement') || typeLower.includes('stock')) return 'bg-info';
        if (typeLower.includes('suppression')) return 'bg-danger';
        return 'bg-warning text-dark';
    }

    /*]]>*/
</script>

</body>
</html>