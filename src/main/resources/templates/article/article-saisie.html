<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="modele/base :: layout(~{::title}, ~{::section})">
<head>
    <meta charset="UTF-8">
    <title>Ajouter un nouvel article</title>

    <!-- CSS Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
</head>
<body>
<section>
    <div class="container">
        <!-- En-tête avec titre et bouton retour -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Ajouter un nouvel article</h1>
            <a th:href="@{/admin/article/list}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </a>
        </div>

        <!-- Messages d'erreur/succès -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Formulaire d'insertion -->
        <div class="card shadow">
            <div class="card-body">
                <form th:action="@{/admin/article/save}" method="post" th:object="${article}" id="articleForm">

                    <!-- Désignation -->
                    <div class="mb-3">
                        <label for="designation" class="form-label fw-bold">
                            Désignation <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="designation"
                               name="designation"
                               th:field="*{designation}"
                               placeholder="Ex: Ordinateur portable Dell XPS 13"
                               required
                               minlength="3"
                               maxlength="200">
                        <div class="form-text">
                            Nom complet de l'article (3 à 200 caractères)
                        </div>
                        <div th:if="${#fields.hasErrors('designation')}" class="text-danger">
                            <small th:errors="*{designation}"></small>
                        </div>
                    </div>

                    <!-- Seuil minimum -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="seuilMinimum" class="form-label fw-bold">
                                Seuil minimum <span class="text-danger">*</span>
                            </label>
                            <input type="number"
                                   class="form-control"
                                   id="seuilMinimum"
                                   name="seuilMinimum"
                                   th:field="*{seuilMin}"
                                   min="0"
                                   step="1"
                                   placeholder="Ex: 10"
                                   required>
                            <div class="form-text">
                                Quantité en dessous de laquelle une alerte sera déclenchée
                            </div>
                            <div th:if="${#fields.hasErrors('seuilMin')}" class="text-danger">
                                <small th:errors="*{seuilMin}"></small>
                            </div>
                        </div>

                        <!-- Unité de mesure -->
                        <div class="col-md-6 mb-3">
                            <label for="udm" class="form-label fw-bold">
                                Unité de mesure <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-searchable"
                                    id="udm"
                                    name="udm"
                                    th:field="*{udm}"
                                    data-placeholder="Recherchez ou sélectionnez une unité..."
                                    required>
                                <option value=""></option> <!-- Option vide pour le placeholder -->
                                <option th:each="unite : ${unites}"
                                        th:value="${unite.getId()}"
                                        th:text="${unite.getDescription()  + ' - ' + unite.getAcronyme()}">
                                </option>
                            </select>
                            <div class="form-text">
                                Unité utilisée pour la gestion du stock
                            </div>
                            <div th:if="${#fields.hasErrors('udm')}" class="text-danger">
                                <small th:errors="*{udm}"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Famille -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="famille" class="form-label fw-bold">
                                Famille <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-searchable"
                                    id="famille"
                                    name="famille"
                                    th:field="*{famille}"
                                    data-placeholder="Recherchez ou sélectionnez une famille..."
                                    required>
                                <option value=""></option>
                                <option th:each="fam : ${familles}"
                                        th:value="${fam.getId()}"
                                        th:text="${fam.getDescription()}">
                                </option>
                            </select>
                            <div class="form-text">
                                Catégorie à laquelle appartient l'article
                            </div>
                            <div th:if="${#fields.hasErrors('famille')}" class="text-danger">
                                <small th:errors="*{famille}"></small>
                            </div>
                        </div>

                        <!-- Centre budgétaire -->
                        <div class="col-md-6 mb-3">
                            <label for="centreBudgetaire" class="form-label fw-bold">
                                Centre budgétaire <span class="text-danger">*</span>
                            </label>
                            <select class="form-select select2-searchable"
                                    id="centreBudgetaire"
                                    name="centreBudgetaire"
                                    th:field="*{centreBudgetaire}"
                                    data-placeholder="Recherchez ou sélectionnez un centre..."
                                    required>
                                <option value=""></option>
                                <option th:each="centre : ${centres}"
                                        th:value="${centre.getId()}"
                                        th:text="${centre.getCodeCentre()}">
                                </option>
                            </select>
                            <div class="form-text">
                                Centre responsable du budget de l'article
                            </div>
                            <div th:if="${#fields.hasErrors('centreBudgetaire')}" class="text-danger">
                                <small th:errors="*{centreBudgetaire}"></small>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <a th:href="@{/admin/article/list}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Enregistrer l'article
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informations additionnelles -->
        <div class="mt-4">
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Informations</h6>
                <ul class="mb-0">
                    <li>Le code article sera généré automatiquement</li>
                    <li>Le stock initial sera de 0 unités</li>
                    <li>Une alerte sera déclenchée lorsque le stock atteindra le seuil minimum</li>
                    <li>Tous les champs marqués d'un astérisque (<span class="text-danger">*</span>) sont obligatoires</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<!-- Script pour améliorer l'expérience utilisateur -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Focus sur le premier champ
        document.getElementById('designation').focus();

        // Validation en temps réel
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.checkValidity()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    });
</script>

<!-- Script Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialiser tous les select avec la classe select2-searchable
        $('.select2-searchable').select2({
            theme: 'bootstrap-5',
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "Aucun résultat trouvé";
                },
                searching: function() {
                    return "Recherche en cours...";
                }
            }
        });

        // S'assurer que Select2 fonctionne avec la validation Bootstrap
        $('.select2-searchable').on('change', function() {
            $(this).trigger('blur'); // Déclencher la validation
        });

        // Empêcher le formulaire de se soumettre avec Enter dans les champs Select2
        $('.select2-searchable').on('keydown', function(e) {
            if (e.keyCode === 13) {
                e.preventDefault();
            }
        });
    });
</script>
</body>
</html>